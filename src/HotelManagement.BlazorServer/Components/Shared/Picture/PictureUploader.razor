@using HotelManagement.BlazorServer.Models
@using HotelManagement.BlazorServer.Services.Files
@using Microsoft.AspNetCore.Components.Forms

@* Components/Pictures/PictureUploader.razor *@

<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
    @* Header *@
    <div class="px-6 py-4 border-b border-gray-100">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">@Config.Title</h3>
                <p class="text-sm text-gray-500 mt-0.5">@Config.Subtitle</p>
            </div>
            @if (Pictures.Count > 0)
            {
                <span class="text-sm text-gray-500">
                    @Pictures.Count / @(Config.MaxFiles == 0 ? "∞" : Config.MaxFiles.ToString())
                </span>
            }
        </div>
    </div>

    <div class="p-6 space-y-6">
        @* Drop Zone *@
        @if (CanAddMore)
        {
            <div class="@GetDropZoneClass()"
                 @ondragenter="HandleDragEnter"
                 @ondragleave="HandleDragLeave"
                 @ondragover:preventDefault="true"
                 @ondrop="HandleDrop"
                 @ondrop:preventDefault="true">
                
                <InputFile OnChange="HandleFileSelection"
                           multiple
                           accept="@GetAcceptString()"
                           class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                           id="@_inputId" />
                
                <div class="flex flex-col items-center justify-center py-8 pointer-events-none">
                    @if (_isDragging)
                    {
                        <div class="w-16 h-16 rounded-full bg-coral-100 flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-coral-600 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                            </svg>
                        </div>
                        <p class="text-lg font-medium text-coral-700">Drop files here</p>
                    }
                    else
                    {
                        <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <p class="text-base font-medium text-gray-700 mb-1">
                            Drag and drop images here
                        </p>
                        <p class="text-sm text-gray-500 mb-4">
                            or <span class="text-coral-600 font-medium">browse files</span>
                        </p>
                        <p class="text-xs text-gray-400">
                            @Config.AllowedExtensions • Max @FormatFileSize(Config.MaxFileSizeBytes) per file
                        </p>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center bg-gray-50">
                <p class="text-gray-500">Maximum number of pictures reached (@Config.MaxFiles)</p>
            </div>
        }

        @* Uploaded Pictures Grid *@
        @if (Pictures.Count > 0)
        {
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-700">Uploaded Pictures</h4>
                    <p class="text-xs text-gray-500">Drag to reorder • Click star to set as main</p>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    @foreach (var picture in Pictures.OrderBy(p => p.DisplayOrder))
                    {
                        <div class="relative group">
                            @* Picture Card *@
                            <div class="@GetPictureCardClass(picture)">
                                @if (picture.IsUploading)
                                {
                                    @* Upload Progress *@
                                    <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 rounded-xl">
                                        <div class="w-10 h-10 mb-2">
                                            <svg class="animate-spin text-coral-500" viewBox="0 0 24 24" fill="none">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                                <path class="opacity-75" fill="currentColor" 
                                                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-600">
                                            @(picture.UploadProgress ?? 0)%
                                        </span>
                                    </div>
                                }
                                else if (picture.HasError)
                                {
                                    @* Error State *@
                                    <div class="absolute inset-0 flex flex-col items-center justify-center bg-red-50 rounded-xl p-2">
                                        <svg class="w-8 h-8 text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <p class="text-xs text-red-600 text-center line-clamp-2">@picture.ErrorMessage</p>
                                        <button type="button" 
                                                class="mt-2 text-xs text-red-600 hover:text-red-800 font-medium"
                                                @onclick="() => RemovePicture(picture)">
                                            Remove
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    @* Image Preview *@
                                    <img src="@picture.Url" 
                                         alt="@(picture.AltText ?? picture.FileName)"
                                         class="w-full h-full object-cover rounded-xl" />
                                    
                                    @* Main Badge *@
                                    @if (picture.IsMain)
                                    {
                                        <div class="absolute top-2 left-2 px-2 py-1 bg-coral-500 text-white 
                                                    text-xs font-medium rounded-full shadow-sm">
                                            Main
                                        </div>
                                    }
                                    
                                    @* Hover Overlay *@
                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 
                                                transition-colors rounded-xl flex items-center justify-center 
                                                opacity-0 group-hover:opacity-100">
                                        <div class="flex items-center gap-2">
                                            @* Set as Main Button *@
                                            @if (!picture.IsMain)
                                            {
                                                <button type="button"
                                                        class="p-2 bg-white rounded-full shadow-lg 
                                                               hover:bg-coral-50 transition-colors"
                                                        title="Set as main picture"
                                                        @onclick="() => SetAsMain(picture)">
                                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                              d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                                    </svg>
                                                </button>
                                            }
                                            
                                            @* Edit Alt Text Button *@
                                            <button type="button"
                                                    class="p-2 bg-white rounded-full shadow-lg 
                                                           hover:bg-gray-50 transition-colors"
                                                    title="Edit description"
                                                    @onclick="() => OpenAltTextEditor(picture)">
                                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            
                                            @* Remove Button *@
                                            <button type="button"
                                                    class="p-2 bg-white rounded-full shadow-lg 
                                                           hover:bg-red-50 transition-colors"
                                                    title="Remove picture"
                                                    @onclick="() => RemovePicture(picture)">
                                                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            @* File Info *@
                            @if (!picture.IsUploading && !picture.HasError)
                            {
                                <p class="mt-2 text-xs text-gray-500 truncate" title="@picture.FileName">
                                    @picture.FileName
                                </p>
                                <p class="text-xs text-gray-400">@picture.FormattedSize</p>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @* Validation Message *@
        @if (Config.RequireAtLeastOne && Pictures.Count(p => !p.HasError && !p.IsUploading) == 0)
        {
            <p class="text-sm text-amber-600 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                At least one picture is required
            </p>
        }
    </div>
</div>

@* Alt Text Editor Modal *@
@if (_showAltTextEditor && _editingPicture is not null)
{
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" @onclick="CloseAltTextEditor"></div>
        
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900">Edit Description</h3>
                </div>
                
                <div class="p-6 space-y-4">
                    <div class="aspect-video rounded-xl overflow-hidden bg-gray-100">
                        <img src="@_editingPicture.Url" 
                             alt="Preview" 
                             class="w-full h-full object-cover" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Alt Text / Description
                        </label>
                        <textarea @bind="_editingAltText"
                                  rows="3"
                                  class="w-full px-4 py-3 border border-gray-200 rounded-xl 
                                         focus:outline-none focus:ring-2 focus:ring-coral-500 
                                         focus:border-transparent resize-none"
                                  placeholder="Describe this image for accessibility..."></textarea>
                        <p class="mt-1 text-xs text-gray-500">
                            Helps with accessibility and SEO
                        </p>
                    </div>
                </div>
                
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                    <button type="button"
                            class="px-4 py-2 text-sm font-medium text-gray-600 bg-white 
                                   border border-gray-200 rounded-lg hover:bg-gray-50"
                            @onclick="CloseAltTextEditor">
                        Cancel
                    </button>
                    <button type="button"
                            class="px-5 py-2 text-sm font-medium text-white bg-coral-600 
                                   rounded-lg hover:bg-coral-700"
                            @onclick="SaveAltText">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public PictureUploaderConfig Config { get; set; } = new();
    [Parameter] public List<UploadedPictureModel> Pictures { get; set; } = [];
    [Parameter] public EventCallback<List<UploadedPictureModel>> PicturesChanged { get; set; }
    
    /// <summary>
    /// Called when a picture is successfully uploaded
    /// </summary>
    [Parameter] public EventCallback<UploadedPictureModel> OnPictureUploaded { get; set; }
    
    /// <summary>
    /// Called when a picture is removed
    /// </summary>
    [Parameter] public EventCallback<Guid> OnPictureRemoved { get; set; }

    [Inject] private IFileApiService FileService { get; set; } = default!;

    private readonly string _inputId = $"file-input-{Guid.NewGuid():N}";
    private bool _isDragging;
    private bool _showAltTextEditor;
    private UploadedPictureModel? _editingPicture;
    private string? _editingAltText;

    private bool CanAddMore => Config.MaxFiles == 0 || Pictures.Count < Config.MaxFiles;

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles(Config.MaxFiles == 0 ? 100 : Config.MaxFiles);
        await ProcessFiles(files);
    }

    private async Task HandleDrop(DragEventArgs e)
    {
        _isDragging = false;
        // Note: Blazor doesn't support getting files from DragEventArgs directly
        // The InputFile component handles the actual file drop
    }

    private void HandleDragEnter(DragEventArgs e) => _isDragging = true;
    private void HandleDragLeave(DragEventArgs e) => _isDragging = false;

    private async Task ProcessFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (!CanAddMore) break;

            // Validate file type
            if (!Config.AllowedContentTypes.Contains(file.ContentType))
            {
                var errorPicture = new UploadedPictureModel
                {
                    FileName = file.Name,
                    ErrorMessage = $"Invalid file type. Allowed: {Config.AllowedExtensions}",
                    DisplayOrder = Pictures.Count
                };
                await AddPicture(errorPicture);
                continue;
            }

            // Validate file size
            if (file.Size > Config.MaxFileSizeBytes)
            {
                var errorPicture = new UploadedPictureModel
                {
                    FileName = file.Name,
                    ErrorMessage = $"File too large. Max size: {FormatFileSize(Config.MaxFileSizeBytes)}",
                    DisplayOrder = Pictures.Count
                };
                await AddPicture(errorPicture);
                continue;
            }

            // Create placeholder for upload progress
            var uploadingPicture = new UploadedPictureModel
            {
                FileName = file.Name,
                ContentType = file.ContentType,
                SizeInBytes = file.Size,
                IsUploading = true,
                UploadProgress = 0,
                DisplayOrder = Pictures.Count,
                IsMain = Pictures.Count == 0 // First picture is main
            };

            await AddPicture(uploadingPicture);
            
            // Upload file
            await UploadFileAsync(file, uploadingPicture);
        }
    }

    private async Task UploadFileAsync(IBrowserFile file, UploadedPictureModel picture)
    {
        try
        {
            // Simulate progress updates
            picture.UploadProgress = 25;
            await NotifyPicturesChanged();
            
            await using var stream = file.OpenReadStream(Config.MaxFileSizeBytes);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;
            
            picture.UploadProgress = 50;
            await NotifyPicturesChanged();

            var result = await FileService.UploadAsync(
                memoryStream,
                file.Name,
                file.ContentType);

            picture.UploadProgress = 75;
            await NotifyPicturesChanged();

            result.Switch(
                response =>
                {
                    picture.StoredFileId = response.Id;
                    picture.Url = response.Url;
                    picture.FileName = response.FileName;
                    picture.SizeInBytes = response.SizeInBytes;
                    picture.IsUploading = false;
                    picture.UploadProgress = null;
                },
                errors =>
                {
                    picture.IsUploading = false;
                    picture.UploadProgress = null;
                    picture.ErrorMessage = errors.First().Description;
                }
            );

            await NotifyPicturesChanged();

            if (!picture.HasError && OnPictureUploaded.HasDelegate)
            {
                await OnPictureUploaded.InvokeAsync(picture);
            }
        }
        catch (Exception ex)
        {
            picture.IsUploading = false;
            picture.UploadProgress = null;
            picture.ErrorMessage = $"Upload failed: {ex.Message}";
            await NotifyPicturesChanged();
        }
    }

    private async Task SetAsMain(UploadedPictureModel picture)
    {
        foreach (var p in Pictures)
        {
            p.IsMain = p == picture;
        }
        await NotifyPicturesChanged();
    }

    private async Task RemovePicture(UploadedPictureModel picture)
    {
        var wasMain = picture.IsMain;
        Pictures.Remove(picture);
        
        // Reassign display orders
        for (int i = 0; i < Pictures.Count; i++)
        {
            Pictures[i].DisplayOrder = i;
        }
        
        // If removed picture was main, set first remaining as main
        if (wasMain && Pictures.Count > 0)
        {
            var firstValid = Pictures.FirstOrDefault(p => !p.HasError && !p.IsUploading);
            if (firstValid != null)
            {
                firstValid.IsMain = true;
            }
        }

        await NotifyPicturesChanged();

        if (picture.StoredFileId != Guid.Empty && OnPictureRemoved.HasDelegate)
        {
            await OnPictureRemoved.InvokeAsync(picture.StoredFileId);
        }
    }

    private void OpenAltTextEditor(UploadedPictureModel picture)
    {
        _editingPicture = picture;
        _editingAltText = picture.AltText;
        _showAltTextEditor = true;
    }

    private void CloseAltTextEditor()
    {
        _showAltTextEditor = false;
        _editingPicture = null;
        _editingAltText = null;
    }

    private async Task SaveAltText()
    {
        if (_editingPicture is not null)
        {
            _editingPicture.AltText = _editingAltText;
            await NotifyPicturesChanged();
        }
        CloseAltTextEditor();
    }

    private async Task AddPicture(UploadedPictureModel picture)
    {
        Pictures.Add(picture);
        await NotifyPicturesChanged();
    }

    private async Task NotifyPicturesChanged()
    {
        await PicturesChanged.InvokeAsync(Pictures);
        StateHasChanged();
    }

    private string GetDropZoneClass()
    {
        var baseClass = "relative border-2 border-dashed rounded-xl transition-all duration-200 ";
        return baseClass + (_isDragging 
            ? "border-coral-400 bg-coral-50" 
            : "border-gray-300 hover:border-coral-400 hover:bg-gray-50");
    }

    private string GetPictureCardClass(UploadedPictureModel picture)
    {
        var baseClass = "aspect-square rounded-xl overflow-hidden relative ";
        if (picture.HasError)
            return baseClass + "border-2 border-red-300 bg-red-50";
        if (picture.IsMain)
            return baseClass + "ring-2 ring-coral-500 ring-offset-2";
        return baseClass + "border border-gray-200";
    }

    private string GetAcceptString() => string.Join(",", Config.AllowedContentTypes);

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        int order = 0;
        double size = bytes;

        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }

        return $"{size:0.##} {sizes[order]}";
    }
}
