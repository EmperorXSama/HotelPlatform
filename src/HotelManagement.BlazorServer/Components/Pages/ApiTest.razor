@page "/api-test"
@using HotelManagement.BlazorServer.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IHotelApiClient ApiClient
@inject ILogger<ApiTest> Logger

<PageTitle>API Test</PageTitle>

<h1>API Integration Test</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h5>Test API Endpoints</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary me-2 mb-2" @onclick="TestPublicEndpoint">
                    Test Public
                </button>
                <button class="btn btn-success me-2 mb-2" @onclick="TestAuthenticatedEndpoint">
                    Test Authenticated
                </button>
                <button class="btn btn-warning me-2 mb-2" @onclick="TestMyInfo">
                    Test My Info
                </button>
                <button class="btn btn-danger mb-2" @onclick="TestAdminEndpoint">
                    Test Admin Only
                </button>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="alert alert-info">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Loading...
            </div>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger">
                <strong>Error:</strong> @_errorMessage
            </div>
        }

        @if (_response is not null)
        {
            <div class="card">
                <div class="card-header bg-success text-white">
                    Response
                </div>
                <div class="card-body">
                    <pre class="mb-0">@_response</pre>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool _isLoading;
    private string? _errorMessage;
    private string? _response;

    private async Task TestPublicEndpoint()
    {
        await CallApiAsync<object>("/api/TestAuth/public");
    }

    private async Task TestAuthenticatedEndpoint()
    {
        await CallApiAsync<object>("/api/TestAuth/authenticated");
    }

    private async Task TestMyInfo()
    {
        await CallApiAsync<object>("/api/TestAuth/my-info");
    }

    private async Task TestAdminEndpoint()
    {
        await CallApiAsync<object>("/api/TestAuth/admin-only");
    }

    private async Task CallApiAsync<T>(string endpoint)
    {
        _isLoading = true;
        _errorMessage = null;
        _response = null;

        try
        {
            var result = await ApiClient.GetAsync<T>(endpoint);
            _response = System.Text.Json.JsonSerializer.Serialize(
                result,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            string? somr = null;
        }
        catch (ApiUnauthorizedException ex)
        {
            _errorMessage = $"Unauthorized: {ex.Message}";
            Logger.LogWarning("Unauthorized access to {Endpoint}", endpoint);
        }
        catch (ApiForbiddenException ex)
        {
            _errorMessage = $"Forbidden: {ex.Message}";
            Logger.LogWarning("Forbidden access to {Endpoint}", endpoint);
        }
        catch (ApiException ex)
        {
            _errorMessage = $"API Error: {ex.Message}";
            Logger.LogError(ex, "API call failed for {Endpoint}", endpoint);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            Logger.LogError(ex, "Unexpected error calling {Endpoint}", endpoint);
        }
        finally
        {
            _isLoading = false;
        }
    }
}